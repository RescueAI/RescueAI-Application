<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.min.js"> </script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"> </script>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RescueAI hehe</title>
  <script src="./render.js" type="module" defer></script>
</head>
<body>


  <section id="left-panel">
    <!--Mission plaaning stuff will go here-->
  </section>

  <section id="right-panel">

    <!--Camera output with navigation buttons here-->
    <canvas id="image-output">

    </canvas>

    <img id="img" alt="">
    <button id="button">Click</button>
    <button id ="camera">Camera</button>
    

  </section>


  <!--Inline JS stuff below-->

  <script async src="./opencv.js" onload="openCvReady();"></script>
  <script>
    let cvReady = false;
    const canvas = document.getElementById('image-output');

    const FPS = 30;
    const height = 320;
    const width = 480;
    let img;
    let lastImg;

    const model = cocoSsd;

    document.getElementById('button').onclick = () => {
      fetch("http://localhost:6969/light");
    }

    document.getElementById('camera').onclick = () => {
      processVideo();
    }

    function processVideo() {
      console.log('processing video')
      fetch("http://localhost:6969/camera")
      .then(data => {
        return data.blob();
      })
      .then(blob => {
        img = URL.createObjectURL(blob);
        lastImg = img;
      })
      .catch(err => {
        console.log(err);
      })
      document.getElementById('img').setAttribute('src', img);
      const context = canvas.getContext('2d');
      outImg = new Image();
      outImg.src = img;
      outImg.onload = () => {
        context.drawImage(outImg, 0 ,0)
        console.log("img drawn")
      }

      if (!cvReady) return;
      console.log("CV stuff happening")
      if (img) {
          let mat = cv.matFromImageData(img);
          cv.imwrite('image-output', mat);
        }

        if(!lastImg) return;
        let mat = cv.matFromImageData(lastImg);
        /*model.load().then((mdl) => {
        mdl.detect(mat).then(predictions => {
          //do stuff
        })*/
    }

    setInterval(processVideo, 20);

    function openCvReady() {
      cv['onRuntimeInitialized'] = () => {
        //TODO: Put cv stuff here
        cvReady = true;
       /* if (img) {
          let mat = cv.imread(img);
          cv.imwrite('image-output', mat);
        }

        if(!lastImg) return;
        let mat = cv.imread(lastimg);
        model.load().then((mdl) => {
        mdl.detect(mat).then(predictions => {
          //do stuff
        })
    })
    */     
      }
    }
    

    openCvReady()
  </script>
</body>
</html>